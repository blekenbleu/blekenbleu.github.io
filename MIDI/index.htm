<html>
<head>
<style> body { margin-left: 80px; } ul {margin-top:0} </style>
<title>Wi-Fi MIDI</title>
</head>
<body>
<h3>Wi-Fi MIDI</h3>
<dl>
<dt><font color=red><a href="../ESP32/midi.htm">ESP32-S2 USB MIDI</a> does not composite well with other devices (CDC, HID gamepad)</font>
<dd>Instead, send MIDI over Wi-Fi, preferably by WebSocket
<dd><i>See also</i>:
<a href="https://www.racedepartment.com/threads/simhub-plugin-s-for-output-to-midi-and-vjoy.210079/post-3446448">Race Department wireless MIDI thread</a>
<dd> &nbsp

<dt><b>Wireless MIDI flavors</b><ul>

<li><a href="#DSMI">DSMI</a> - old <a href="DS_MIDI_WiFi.md">protocol for Nintendo DS</a>

<li><a href="https://www.nerds.de/en/ipmidi.html">ipMIDI</a> - proprietary $79 (60 min. free trial)<br>
One of two MIDI-over-UDP protocols, uses "well-known" port;
<br>Arduino can be a relatively simple client.

<li><a href="#AM">Apple MIDI</a> - AKA RTP MIDI UDP depending on DNS broadcast
<br>Arduino must be a relatively complex server

<li><a href="#WS">WebSocket MIDI</a> - similar to Apple MIDI, except by TCP WebSocket instead of UDP<br>
  &nbsp For ESP32, AsyncUDP is bundled with Arduino core,<br>
  &nbsp but separate from AsyncTCP wanted for efficient webserver,<br>
  &nbsp making this <i>perhaps</i> the most efficient implementation.<br>
  &nbsp <br>
  <b>Apple MIDI</b> parser bundled in the
  <a href="https://github.com/lathoub/Arduino-AppleMIDI-Library/blob/master/src/AppleMIDI_Parser.h">Arduino
     library</a> does not seem robust;<br>
  &nbsp alternatives exist, e.g. in <a href="https://github.com/davidmoreno/rtpmidid">librtpmidid (C++)</a> and
   <a href="https://github.com/cbdevnet/midimonster">MIDIMonster (C)</a>
   <a href="https://github.com/cbdevnet/midimonster/blob/master/backends/rtpmidi.c">backend</a><br>
  &nbsp rtpmidid includes good-looking tests, despite C++...

<li><a href="#WM">WebMIDI</a> - similar to WebSocket MIDI; accessible from web browsers
</ul>

<a name=DSMI>
<dt>Android <b>Wireless Mixer</b> app using <a href="https://forum.gbadev.org/viewtopic.php?t=11811">DSMI</a>
<dd><a href="https://trajkovski.net/support.html">Trajkovski Labs support page</a><br>
<a href="DS_MIDI_WiFi">Installation</a></a>
<details><summary>Wireless Mixer MIDI map (CC numbers, decimal)</summary>
  &nbsp  &nbsp Master volume = 7<br>
  &nbsp  &nbsp Play = 118<br>
  &nbsp  &nbsp Stop = 120<br>
  &nbsp  &nbsp Record = 119<br>
  &nbsp  &nbsp Left = 4<br>
  &nbsp  &nbsp Right = 5<br>
  &nbsp  &nbsp Previous = 2<br>
  &nbsp  &nbsp Next = 1<br>
<table><tr><td>
   Slider1 = 8<br>
   Slider2 = 9<br>
   Slider3 = 10<br>
   Slider4 = 12<br>
   Slider5 = 13<br>
   Slider6 = 14<br>
   Slider7 = 15<br>
   Slider8 = 16<br>
   Slider9 = 17<br>
   Slider10 = 18<br>
   Slider11 = 19<br>
   Slider12 = 20<br>
</td><td>
  &nbsp  &nbsp Pan1 = 23<br>
  &nbsp  &nbsp Pan2 = 24<br>
  &nbsp  &nbsp Pan3 = 25<br>
  &nbsp  &nbsp Pan4 = 26<br>
  &nbsp  &nbsp Pan5 = 27<br>
  &nbsp  &nbsp Pan6 = 28<br>
  &nbsp  &nbsp Pan7 = 29<br>
  &nbsp  &nbsp Pan8 = 30<br>
  &nbsp  &nbsp Pan9 = 31<br>
  &nbsp  &nbsp Pan10 = 33<br>
  &nbsp  &nbsp Pan11 = 34<br>
  &nbsp  &nbsp Pan12 = 35<br>
</td><td>
  &nbsp  &nbsp Knob1-1 = 39<br>
  &nbsp  &nbsp Knob1-2 = 40<br>
  &nbsp  &nbsp Knob1-3 = 41<br>
  &nbsp  &nbsp Knob1-4 = 42<br>
  &nbsp  &nbsp Knob1-5 = 43<br>
  &nbsp  &nbsp Knob1-6 = 44<br>
  &nbsp  &nbsp Knob1-7 = 45<br>
  &nbsp  &nbsp Knob1-8 = 46<br>
  &nbsp  &nbsp Knob1-9 = 47<br>
  &nbsp  &nbsp Knob1-10 = 48<br>
  &nbsp  &nbsp Knob1-11 = 49<br>
  &nbsp  &nbsp Knob1-12 = 50<br>
</td><td>
  &nbsp  &nbsp Knob2-1 = 53<br>
  &nbsp  &nbsp Knob2-2 = 54<br>
  &nbsp  &nbsp Knob2-3 = 55<br>
  &nbsp  &nbsp Knob2-4 = 56<br>
  &nbsp  &nbsp Knob2-5 = 57<br>
  &nbsp  &nbsp Knob2-6 = 58<br>
  &nbsp  &nbsp Knob2-7 = 59<br>
  &nbsp  &nbsp Knob2-8 = 60<br>
  &nbsp  &nbsp Knob2-9 = 61<br>
  &nbsp  &nbsp Knob2-10 = 62<br>
  &nbsp  &nbsp Knob2-11 = 63<br>
  &nbsp  &nbsp Knob2-12 = 65<br>
</td><td>
  &nbsp  &nbsp Knob3-1 = 102<br>
  &nbsp  &nbsp Knob3-2 = 103<br>
  &nbsp  &nbsp Knob3-3 = 104<br>
  &nbsp  &nbsp Knob3-4 = 105<br>
  &nbsp  &nbsp Knob3-5 = 106<br>
  &nbsp  &nbsp Knob3-6 = 107<br>
  &nbsp  &nbsp Knob3-7 = 108<br>
  &nbsp  &nbsp Knob3-8 = 109<br>
  &nbsp  &nbsp Knob3-9 = 110<br>
  &nbsp  &nbsp Knob3-10 = 111<br>
  &nbsp  &nbsp Knob3-11 = 112<br>
  &nbsp  &nbsp Knob3-12 = 113<br>
</td></tr><tr><td>
  Mute1 = 66<br>
  Mute2 = 67<br>
  Mute3 = 68<br>
  Mute4 = 69<br>
  Mute5 = 70<br>
  Mute6 = 71<br>
  Mute7 = 72<br>
  Mute8 = 73<br>
  Mute9 = 74<br>
  Mute10 = 75<br>
  Mute11 = 76<br>
  Mute12 = 77<br>
</td><td>
  &nbsp  &nbsp Solo1 = 78<br>
  &nbsp  &nbsp Solo2 = 79<br>
  &nbsp  &nbsp Solo3 = 80<br>
  &nbsp  &nbsp Solo4 = 81<br>
  &nbsp  &nbsp Solo5 = 82<br>
  &nbsp  &nbsp Solo6 = 83<br>
  &nbsp  &nbsp Solo7 = 84<br>
  &nbsp  &nbsp Solo8 = 85<br>
  &nbsp  &nbsp Solo9 = 86<br>
  &nbsp  &nbsp Solo10 = 87<br>
  &nbsp  &nbsp Solo11 = 88<br>
  &nbsp  &nbsp Solo12 = 89<br>
</td><td>
  &nbsp  &nbsp Rec1 = 90<br>
  &nbsp  &nbsp Rec2 = 91<br>
  &nbsp  &nbsp Rec3 = 92<br>
  &nbsp  &nbsp Rec4 = 93<br>
  &nbsp  &nbsp Rec5 = 94<br>
  &nbsp  &nbsp Rec6 = 95<br>
  &nbsp  &nbsp Rec7 = 96<br>
  &nbsp  &nbsp Rec8 = 97<br>
  &nbsp  &nbsp Rec9 = 98<br>
  &nbsp  &nbsp Rec10 = 99<br>
  &nbsp  &nbsp Rec11 = 100<br>
  &nbsp  &nbsp Rec12 = 101<br>
</td><td>
  &nbsp  &nbsp ExBtn1_1 = 11<br>
  &nbsp  &nbsp ExBtn1_2 = 21<br>
  &nbsp  &nbsp ExBtn1_3 = 22<br>
  &nbsp  &nbsp ExBtn1_4 = 32<br>
  &nbsp  &nbsp ExBtn1_5 = 36<br>
  &nbsp  &nbsp ExBtn1_6 = 37<br>
  &nbsp  &nbsp ExBtn1_7 = 38<br>
  &nbsp  &nbsp ExBtn1_8 = 51<br>
  &nbsp  &nbsp ExBtn1_9 = 52<br>
  &nbsp  &nbsp ExBtn1_10 = 124<br>
  &nbsp  &nbsp ExBtn1_11 = 125<br>
  &nbsp  &nbsp ExBtn1_12 = 126<br>
</td><td>
  &nbsp  &nbsp ExBtn2_1 = 114<br>
  &nbsp  &nbsp ExBtn2_2 = 115<br>
  &nbsp  &nbsp ExBtn2_3 = 116<br>
  &nbsp  &nbsp ExBtn2_4 = 117<br>
  &nbsp  &nbsp ExBtn2_5 = 121<br>
  &nbsp  &nbsp ExBtn2_6 = 122<br>
  &nbsp  &nbsp ExBtn2_7 = 123<br>
  &nbsp  &nbsp ExBtn2_8 = 127<br>
  &nbsp  &nbsp ExBtn2_9 = 64<br>
  &nbsp  &nbsp ExBtn2_10 = 6<br>
  &nbsp  &nbsp ExBtn2_11 = 5<br>
  &nbsp  &nbsp ExBtn2_12 = 3(?)<br>
</td></tr></table></details>
<dd> &nbsp

<a name=WM>
<dt><font size=+1><b>WebMIDI over WebSocket directly from the web page</b></font></a>
<dd><a href="https://github.com/hhromic/midi-websocket">A general purpose MIDI over WebSocket approach</a>
<br> &nbsp using <a href="https://github.com/Olical/EventEmitter">EventEmitter JavaScript</a>
<dd> &nbsp

<a name=WS>
<dt><font size=+1><b>MIDI over WebSocket</b></a>
<dd><a href="https://github.com/me-no-dev/ESPAsyncWebServer">ESPAsyncWebServer</a> examples include WebSocket server and client examples
<dd><a href="https://randomnerdtutorials.com/esp32-websocket-server-arduino/">ESP32 WebSocket Server</a> - Random Nerd
<dd><a href="https://www.mischianti.org/2020/12/07/websocket-on-arduino-esp8266-and-esp32-client-1">esp32 WebSocket client</a> - Mischianti
<dd><a href="https://www.dfrobot.com/blog-776.html">ESP32 Arduino Tutorial: Websocket client</a> - DFRobot 2017
<br><a href="https://techtutorialsx.com/2017/11/01/esp32-arduino-websocket-client/">ESP32 Arduino: Websocket client</a>
<br> &nbsp <a href="https://github.com/morrissinger/ESP8266-Websocket/tree/master/examples">ESP8266-Websocket server and client examples</a>
<br> &nbsp <a href="https://github.com/skaarj1989/mWebSockets/tree/master/examples/simple-client">simple-client sketch</a>
<dd><a href="https://www.tutorialspoint.com/html5/html5_websocket.htm">HTML5 - WebSockets tutorial</a> with Client-side HTML &amp JavaScript code
<dd><a href="https://medium.com/nebo-15/tutorial-how-to-create-midi-synthesizer-with-midi-api-and-node-js-48d41c162009">Tutorial: How to create a MIDI synthesizer with MIDI API and Node JS</a>
<dd><a href="https://github.com/TrollStation/obs-websockets-midi">OBS-Websockets-MIDI Bridge</a>
<dd> &nbsp

<dt>PC MIDI servers
<dd><a href="https://www.turboirc.com/mcp/manual.htm#connectwin">MCPW.EXE</a>, seemingly compatible with RTP MIDI or TCP;<br>
 &nbsp requires a separate MIDI port provider, e.g. <a href="https://www.tobias-erichsen.de/software/loopmidi.html">loopMIDI</a>
<dd><a href="https://www.tobias-erichsen.de/software/rtpmidi.html">rtpMIDI server</a><br>
<dd><a href="https://xmmc.de/mnet">mnet MIDIHub</b></font></a> 32/64-bit WinMM MIDI driver<br>
 &nbsp with ipMIDI, RTP, WebSocket, WebMIDI and Bluetooth services;<br>
 &nbsp provides its own MIDI ports.<br>
  <img src="MIDIHub.png"><ul>
  <li>as warned, MIDIHub provokes firewall pop-ups for MIDI apps<br>
      <img src="firewall.png">
  <li>"owned" by voicemeeterpro on initial launch
  </ul>
<dd><a href="https://github.com/hhromic/midi-websocket">MIDI WebSocket</a> - includes both nodejs client and server, as well as JavaScript for a web browser client<br>
  &nbsp whether and how compatible with e.g. mnet MIDIHub is unknown..
<dd> &nbsp

<a name=AM>
<dt><b>Apple MIDI over UDP</b></a>
<dd><a href="https://john-lazzaro.github.io//rtpmidi"><b>RTP MIDI</b></a>:
 &nbsp <a href="https://developer.apple.com/library/archive/documentation/Audio/Conceptual/MIDINetworkDriverProtocol/MIDI/MIDI.html">Apple network MIDI (UDP)</a>,
 &nbsp <a href="https://github.com/ohnoitsalobo/sound-reactive-esp32">AppleMIDI with ESPAsyncWebServer examples</a>
<dd>Apple's <a href="https://developer.apple.com/library/archive/documentation/Audio/Conceptual/MIDINetworkDriverProtocol/MIDI/MIDI.html">MIDI
 Network Driver Protocol</a> Document
<dd> &nbsp

<dt><a href="https://projectgus.github.io/hairless-midiserial">Hairless MIDI&lt-&gtSerial Bridge</a>
<dd>connect serial devices (e.g. Arduinos) to send and receive MIDI signals

<dt><a href="https://github.com/madnerdorg/libreconnect">LibreConnect Server</a><dd>generates websockets for serial USB-attached Arduinos
</dl>

<h4>Learning by doing</h4><ul>
<li><a href="">AsyncUDP example</a> - library provided with Expressif ESP32 core for Arduino;<br>
   may be extended for MIDI support as a learning step;  <a href="https://github.com/lathoub/Arduino-AppleMIDI-Library">AppleMIDI for Arduino</a> supports ESP32
<li><a href="">AsyncTCP example</a> - GitHub library; will be extended for MIDI support,<br>
   to avoid running both it (for webserver) and AsyncUDP<ul>
   <li>this sketch can only make a single response per opening</ul>
<li>Restarting Serial Monitor for either of the above examples <i>restarts the connection</i>..
<li>ESP32_NoteOnOffEverySec.ino from
  <a href="https://github.com/lathoub/Arduino-AppleMIDI-Library/tree/master/examples">Arduino-AppleMidi-Library examples</a><ul>
  <li><a href="https://xmmc.de/mnet/">mnet MIDIHub</a> does not seem to work as described<br>
      supposedly hidden by default, multicast ports appear
  <li>RTP ports seemingly <i>only appear if detected</i> by
  <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/mdns.html">multicast DNS</a><br>
  <code>service_type</code> evidently should be <a href="http://www.dns-sd.org/serviceTypes.html"><code>_apple-midi</code></a>.
  </ul>
<li><a href="https://github.com/lathoub/Arduino-AppleMIDI-Library/blob/master/examples/wESP32_NoteOnOffEverySec/wESP32_NoteOnOffEverySec.ino">wESP32_NoteOnOffEverySec.ino</a>
 includes <code>MDNS.addService("apple-midi", "udp", AppleMIDI.getPort());</code><ul>
 <li>replaced <code>ETH.begin();</code> in <code>ETH_Heelper.h:ETH_startup()</code> with <code>WiFi.begin()</code>
 <li>MIDIHub recognizes the device, and the sketch reports <code>Connected to session 4155933516 mnet (ALIENWARE-R7_144) 8</code>,<br>
    but also reports <code>*** ListenerTimeOutException</code> and many <code>*** ParseException</code>,<br>
    which occur in <code>AppleMIDI.hpp:parseControlPackets(),<br>
    based on <code>UnexpectedData</code> returned from <code>AppleMIDI_Parser.h: parse()</code> returning <code>UnexpectedData</code><br>
    which it does for too many reasons: signature, protocolVersion, or not having previously returned something.
 <li>Adding debugging code to <code>AppleMIDI_Parser.h</code> revealed that most ParseExceptions were an unexpected and long signature.
 <li>Added more debugging code to understand AppleMIDI_Parser
<details><summary>then MIDI traffic <i>sometimes</i> began flowing:</summary>
<pre>ESP-ROM:esp32s2-rc4-20191025
Build:Oct 25 2019
rst:0x1 (POWERON),boot:0x8 (SPI_FAST_FLASH_BOOT)
SPIWP:0xee
mode:DIO, clock div:1
load:0x3ffe6100,len:0x570
load:0x4004c000,len:0xa50
load:0x40050000,len:0x28d8
entry 0x4004c18c
wESP32_NoteOnOffEverySec.ino Booting
Establishing connection to WiFi..
Establishing connection to WiFi..
Establishing connection to WiFi..
Establishing connection to WiFi..
Establishing connection to WiFi..
Connected to network as  192.168.1.185
OK, now make sure an rtpMIDI session is Enabled
Add device named Arduino with Host 192.168.1.185 Port 5004
The device should also be visible in the directory as AppleMIDI-ESP32
Select and then press the Connect button
Then open a MIDI listener and monitor incoming notes
amSignature match
amSynchronization match
*** ParticipantNotFoundException -772189380
amSignature match
amSynchronization match
*** ParticipantNotFoundException -772189380
amSignature match
amSynchronization match
*** ParticipantNotFoundException -772189380
amSignature match
amInvitation match
amProtocolVersion match
amSignature match
amInvitation match
amProtocolVersion match
amSignature match
amInvitation match
amProtocolVersion match
Connected to session 3522777916 mnet (ALIENWARE-R7_144)
first MIDI.sendNoteOn()</pre></details>
  MIDI-OX must connect to the configured MIDIHub port (e.g. <code>MIDIHUB PORT 2</code> <i>after</i>
  <li><i>Without</i> Serial Monitor running and <i>with</i> MidiView already watching <code>MIDIHUB PORT 2</code>,<br>
  MIDI traffic seems to flow OK..<br>
  &nbsp MIDIHub <i>sometimes</i> allows both MIDI_OX and MidiView
  to simultaneously read <code>MIDIHUB PORT</code>.
 </ul>
</ul>
<dt><a href="https://github.com/lathoub/Arduino-ipMIDI"><b>Arduino ipMIDI Transport</b><a> on <code>MIDIHUB PORT 1</code>
<dd>The <a href="https://github.com/blekenbleu/composite_sketches/blob/main/ESP32_NoteOnOffipMIDI/ESP32_NoteOnOffipMIDI.ino">ESP32_NoteOnOffipMIDI
  sketch</a> seems too simple to work with MIDIHub.. but it <i>sometimes does</i>.<br>
  It seems to work most consistently when Serial Monitor is used until notes start,<br>
  &nbsp then connecting MidiView to MIDIHUB PORT 1,<br>
  but it still (also) occasionally stops for no known reason..<br>
  <a href="http://livehelp.solidstatelogic.com/Help/ipMIDI.html">This page</a> describes IP routing magic for ipMIDI.
</dl>
</body>
</html>
